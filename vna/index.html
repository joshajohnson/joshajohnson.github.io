<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Attempting to Build a Low Cost Vector Network Analyser" /><meta property="og:locale" content="en" /><meta name="description" content="Originally posted 2019/11/18" /><meta property="og:description" content="Originally posted 2019/11/18" /><link rel="canonical" href="https://joshajohnson.github.io/vna/" /><meta property="og:url" content="https://joshajohnson.github.io/vna/" /><meta property="og:site_name" content="Josh Johnson" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-11T20:00:00+10:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Attempting to Build a Low Cost Vector Network Analyser" /><meta name="twitter:site" content="@_joshajohnson" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-11T20:00:00+10:00","datePublished":"2022-08-11T20:00:00+10:00","description":"Originally posted 2019/11/18","headline":"Attempting to Build a Low Cost Vector Network Analyser","mainEntityOfPage":{"@type":"WebPage","@id":"https://joshajohnson.github.io/vna/"},"url":"https://joshajohnson.github.io/vna/"}</script><title>Attempting to Build a Low Cost Vector Network Analyser | Josh Johnson</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Josh Johnson"><meta name="application-name" content="Josh Johnson"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/img/josh-mugshot.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">Josh Johnson</a></div><div class="site-subtitle font-italic">Projects from my 5 til 9</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/products/" class="nav-link"> <i class="fa-fw fas fa-plug ml-xl-3 mr-xl-3 unloaded"></i> <span>PRODUCTS</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-hammer ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/joshajohnson" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/_joshajohnson" aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['contact','joshajohnson.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Attempting to Build a Low Cost Vector Network Analyser</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Attempting to Build a Low Cost Vector Network Analyser</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1660212000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 11, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/_joshajohnson">Josh Johnson</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1048 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p><code class="language-plaintext highlighter-rouge">Originally posted 2019/11/18</code></p><p><a href="/assets/2022-08-11-vna/vna-assembled.jpg" class="popup img-link "><img data-src="/assets/2022-08-11-vna/vna-assembled.jpg" alt="assembled VNA" class="lazyload" data-proofer-ignore></a></p><p>For my final year project, I set the rather ambitious goal of designing a low cost vector network analyser (VNA) which would preformant enough to deserve a spot on my bench. As you may have guessed by the title of this post, I ran into a few issues during the process which prevented the VNA from functioning well enough to be used on a day to day basis, however it was a very interesting project to work on.</p><p>For those interested the full write up of the project along with all design files can be found on <a href="https://github.com/joshajohnson/vna/blob/master/Thesis/thesis.pdf">github</a> (warning 25 MB pdf), however Iâ€™ll summarise the key points from the thesis below.</p><h2 id="architecture"><span class="mr-2">Architecture</span><a href="#architecture" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With the goal of the project to keep the price as low as possible, the design choices made at the architectural level played a key role in not only defining cost, but the function and accuracy of the device. The functional block diagram can be found below, with two key cost / performance drivers being the AD8302 gain and phase detector IC, along with the Mini Circuits ADC-15-4+ directional couplers.</p><p><a href="/assets/2022-08-11-vna/block-diag.png" class="popup img-link "><img data-src="/assets/2022-08-11-vna/block-diag.png" alt="functional block diagram" class="lazyload" data-proofer-ignore></a></p><p>The AD8302 is an RFIC which takes two RF inputs and outputs two analog voltages proportional to the phase and voltage difference between the two inputs, and enabled a low cost micro controller to be utilised to determine the magnitude and phase response of the DUT, compared to using an ADC and a bunch of DSP on a FPGA or higher end micro controller to sample, calculate, and transmit the result. This route does have decreased dynamic range, however due to the directional couplers being utilised this was not a limiting factor in the design.</p><p>One requirement I had set for the project was that all components must be COTS, as this made the design easier and cheaper to implement, with an obvious tradeoff in performance. The best directional couplers I was able to find for this project were from MiniCircuits with their ADC-15-4+, which had &gt; 24 dB of directivity over the specified frequency range, and I was even able to push them above the 1 GHz upper frequency bound whilst maintaining enough directivity to be useful for this device.</p><p>Schematics can be found <a href="https://github.com/joshajohnson/vna/blob/master/Hardware/VNA/VNA.pdf">here</a> for the VNA, along with the KiCad design files.</p><h2 id="pcb-design"><span class="mr-2">PCB Design</span><a href="#pcb-design" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>All of the above outlined components need somewhere to live, and four layers of FR4 in a signal/GND/3V3/signal configuration worked well for this application. OSHParkâ€™s design rules were followed, as even though I would be ordering it from a Chinese board house due to my location in Australia, I wanted it to use standard processes which anyone would be able to recreate if the project was successful.</p><p>Not only was this board the most complicated board I designed / laid out to date due to the number of parts and the RF design requirements, it was also one of the earlier boards that I had used 0402 passives, QFN components, and reflowed in my modified T962 oven, and as such required a bit of rework to get it powered up without any shorts.</p><p>I was also fortunate that there only ended up being a small number of issues with the schematic / layout, with only one being critical as it was on the RF path which was easily resolved.</p><p><a href="/assets/2022-08-11-vna/vna-pcb.jpg" class="popup img-link "><img data-src="/assets/2022-08-11-vna/vna-pcb.jpg" alt="assembled PCB" class="lazyload" data-proofer-ignore></a></p><h2 id="firmware--software"><span class="mr-2">Firmware / Software</span><a href="#firmware--software" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The firmware and software for the device were spit into two halves, with the STM32F373 on the VNA being responsible for low level hardware control and sending back frequency/magnitude/phase information, and Python running on a host computer to handle to user interface, do more complicated signal processing and calibration where NumPy and Scikit-rf were able to be utilised, along with proving display of the measured S parameters.</p><p>As someone whose favourite programming language is solder, I took this project as a reason to force myself to do some low level programming, with all the firmware being developed in C using STâ€™s HAL by yours truly. Whilst this led to many hours writing and debugging low level functions such as the USB-serial interface or the command parser, along with the struggles of bringing the MAX2871 PLL up whilst never knowing if the issue was hardware or software (note: it was both) Iâ€™m now much more comfortable with lower level firmware development which will be useful going forwards.</p><p><a href="/assets/2022-08-11-vna/sw-flow.png" class="popup img-link "><img data-src="/assets/2022-08-11-vna/sw-flow.png" alt="sw block diagram" class="lazyload" data-proofer-ignore></a></p><h2 id="performance-and-function"><span class="mr-2">Performance and Function</span><a href="#performance-and-function" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Due to a number of issue which resulted from lack of experience on my behalf, the performance of the VNA was ultimately unsatisfactory, with the phase measurement being near useless. Whilst I wonâ€™t go into the details (thesis contains all the juicy info if you are keen) it primarily came down to a few design decisions including poor filtering of the LOâ€™s numerous harmonics due to the divided down output, strange behaviour of the AD8302 in certain conditions, and issues during calibration caused by a difference in dynamic range between the cal standards and measured values. The first two issues could have been found and resolved with testing during the development process which was not done due to a lack of time and access to resources, and the latter may have been an easy software fix, but was found with two weeks to go and there was not enough time to resolve it.</p><p>With this said, in certain situations the VNA performs well enough to be useful, as can be seen below in comparisons between my design and a commercial Agilent VNA.</p><p><a href="/assets/2022-08-11-vna/900_MHz_LPF_s11.png" class="popup img-link "><img data-src="/assets/2022-08-11-vna/900_MHz_LPF_s11.png" alt="900mhz lfp s11" class="lazyload" data-proofer-ignore></a></p><p><a href="/assets/2022-08-11-vna/LFCN-400-s21.png" class="popup img-link "><img data-src="/assets/2022-08-11-vna/LFCN-400-s21.png" alt="lfcn 400 s21" class="lazyload" data-proofer-ignore></a></p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With all of this said, the VNA is somewhat useful for measurements in the 433 and 915 MHz ISM bands if absolute accuracy is not crucial, however it wonâ€™t be replacing my desire to place a commercial VNA on by bench any time soon.</p><p>It has however provided a very useful learning experience in a bunch of areas such as RF architecture, design, and layout, firmware development, and even mechanical design, and given that I had a whole three months of RF experience before beginning this project Iâ€™m happy that it functioned at all.</p><p>Whatâ€™s next? I still have few components laying around from the build so expect a small RF signal generator to make an appearance in the new year, however due to some fundamental issue with the design of the VNA I wonâ€™t be continuing itâ€™s development any further.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Attempting%20to%20Build%20a%20Low%20Cost%20Vector%20Network%20Analyser%20-%20Josh%20Johnson&url=https%3A%2F%2Fjoshajohnson.github.io%2Fvna%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Attempting%20to%20Build%20a%20Low%20Cost%20Vector%20Network%20Analyser%20-%20Josh%20Johnson&u=https%3A%2F%2Fjoshajohnson.github.io%2Fvna%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fjoshajohnson.github.io%2Fvna%2F&text=Attempting%20to%20Build%20a%20Low%20Cost%20Vector%20Network%20Analyser%20-%20Josh%20Johnson" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/bsidescbr23/">BSides Canberra 2023</a><li><a href="/bsidescbr23-workshop/">BSidesCBR23 Badge Add-on Workshop</a><li><a href="/digital-explorer-board/">Digital Explorer Board</a><li><a href="/sea-picro/">Sea-Picro</a><li><a href="/intro-keyboard/">Intro Keyboard Assembly Instructions</a></ul></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="https://cdn.jsdelivr.net/npm/tocbot@4.20.1/dist/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/bsidescbr23/"><div class="card-body"> <em class="small" data-ts="1693479600" data-df="ll" > Aug 31, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BSides Canberra 2023</h3><div class="text-muted small"><p> Hello! Welcome to the landing page for BSides Canberra 2023. Below are the links youâ€™ve been searching for. Designing a Badge Add-on in KiCad SAO Connector Modification We unfortunately ran out...</p></div></div></a></div><div class="card"> <a href="/bsidescbr23-workshop/"><div class="card-body"> <em class="small" data-ts="1693477800" data-df="ll" > Aug 31, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>BSidesCBR23 Badge Add-on Workshop</h3><div class="text-muted small"><p> Introduction The goal of todayâ€™s workshop is to design and assemble a printed circuit board (PCB) which takes the form of a magpie with a blinking eye. Once assembled, the add-on will plug into yo...</p></div></div></a></div><div class="card"> <a href="/digital-explorer-board/"><div class="card-body"> <em class="small" data-ts="1693476015" data-df="ll" > Aug 31, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Digital Explorer Board</h3><div class="text-muted small"><p> On your bPod, youâ€™ll find a tools menu which provides a way to interface with a number of common embedded protocols. The digital explorer board in combination with a logic analyser provides a way t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/rf-sig-gen/" class="btn btn-outline-primary" prompt="Older"><p>RF Signal Generator</p></a> <a href="/intro-keyboard/" class="btn btn-outline-primary" prompt="Newer"><p>Intro Keyboard Assembly Instructions</p></a></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> Â© 2025 <a href="https://twitter.com/_joshajohnson">Josh Johnson</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
